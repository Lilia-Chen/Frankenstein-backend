name: MotionStreamer
channels:
  - conda-forge
  - defaults
dependencies:
  # ============================================================================
  # Core Python 3.10 (REQUIRED for PyTorch 2.10+ and sm_120 support)
  # ============================================================================
  - python=3.10
  - pip

  # ============================================================================
  # Scientific Computing
  # ============================================================================
  # numpy 1.22.4 — MotionStreamer original. Core inference code does NOT use
  # deprecated np.float, so no need to lock at 1.21.5 like DART.
  # DO NOT upgrade past 1.23.x — np.float removed in 1.24.
  - numpy=1.22.4
  - scipy=1.10.1
  - scikit-learn=1.2.2
  - matplotlib=3.4.3          # 3.4.x compatible with numpy 1.22.4
  - pandas=1.5.3

  # ============================================================================
  # Common System Packages
  # ============================================================================
  - pillow
  - networkx
  - sympy
  - mpmath
  - pyyaml
  - tqdm
  - requests
  - filelock
  - ffmpeg

  # ============================================================================
  # Build Tools — CRITICAL VERSION CONSTRAINTS
  # ============================================================================
  # setuptools MUST be <70: CLIP's setup.py uses pkg_resources which was
  # removed in setuptools 70+. Same pitfall as DART.
  - setuptools<70
  - wheel
  - packaging
  - toml

  # ============================================================================
  # Pip Packages
  # NOTE: torch / torchvision / torchaudio are NOT listed here.
  #       Install them separately after env creation (see setup_rtx5070ti.sh):
  #         pip install torch torchvision torchaudio \
  #             --index-url https://download.pytorch.org/whl/cu128
  # NOTE: clip and pytorch3d are NOT listed here.
  #       Both require --no-build-isolation (same pitfall as DART).
  # ============================================================================
  - pip:
      # ---------- Core Deep Learning ----------
      - einops==0.8.0
      - timm==1.0.12
      - omegaconf==2.3.0
      - hydra-core==1.3.2
      - yacs==0.1.8

      # ---------- Diffusion / Transformers Stack ----------
      - diffusers==0.31.0
      - accelerate==1.0.1
      - transformers==4.46.3
      - tokenizers==0.20.3
      - safetensors==0.4.5
      - sentence-transformers==3.2.1
      - sentencepiece==0.2.0
      - huggingface-hub==0.26.2
      - ftfy==6.1.1
      - regex==2024.11.6

      # ---------- Body Model / Mesh ----------
      - smplx==0.1.28
      - human-body-prior==2.2.2.0
      - chumpy==0.70
      - trimesh==4.6.2
      - shapely==2.0.7
      - triangle==20250106

      # ---------- Rendering / Visualization ----------
      - pyrender==0.1.45
      - pyopengl==3.1.0
      - pyglet==2.1.2
      - glfw==2.8.0
      - imageio==2.9.0
      - imageio-ffmpeg==0.5.1
      - moviepy==0.2.3.1
      - open3d==0.13.0

      # ---------- Training / Logging ----------
      - pytorch-lightning==1.7.0
      - torchmetrics==0.7.0
      - torchgeometry==0.1.2
      - pydeprecate==0.3.2
      - tensorboard==2.12.0
      - tensorboard-data-server==0.7.2
      - tensorboard-plugin-wit==1.8.0

      # ---------- Data / Utils ----------
      - h5py==3.11.0
      - scipy==1.10.1
      - pandas==1.5.3
      - scikit-learn==1.2.2
      - natsort==8.4.0
      - orjson==3.10.15
      - gdown==5.2.0
      - joblib==1.3.2
      - psutil==6.1.0
      - tabulate==0.9.0
      - termcolor==2.4.0
      - rich==13.9.4
      - click==8.1.7
      - typer==0.13.1

      # ---------- NLP (used by some evaluator components) ----------
      - spacy==3.7.5
      - fvcore
      - iopath
      - portalocker

      # ---------- Misc ----------
      - antlr4-python3-runtime==4.9.3
      - ipython
      - pydantic==2.10.1
      - werkzeug==2.0.1
      - markdown==3.3.4
      - pyyaml==6.0.2
      - wrapt==1.17.0

# ============================================================================
# POST-INSTALL INSTRUCTIONS for RTX 5070 Ti (sm_120) Support
# ============================================================================
# Run setup_rtx5070ti.sh after creating this environment.
#
# Quick manual steps:
#
# 1. conda env create -f environment_rtx5070ti.yml
#    conda activate MotionStreamer
#
# 2. PyTorch (sm_120 requires 2.10+ with cu128):
#    pip install torch torchvision torchaudio \
#        --index-url https://download.pytorch.org/whl/cu128
#
# 3. CLIP — MUST clone + --no-build-isolation (same pitfall as DART):
#    git clone https://github.com/openai/CLIP.git /tmp/clip_repo
#    pip install -e /tmp/clip_repo --no-build-isolation
#
# 4. pytorch3d — MUST build from source with --no-build-isolation:
#    git clone https://github.com/facebookresearch/pytorch3d.git /tmp/pytorch3d
#    pip install -e /tmp/pytorch3d --no-build-isolation
#
# 5. Download model checkpoints (from MotionStreamer/ directory):
#    python humanml3d_272/prepare/download_Causal_TAE_t2m_272_ckpt.py
#    python humanml3d_272/prepare/download_t2m_model_ckpt.py
#
# 6. Download sentence-T5-XXL text encoder:
#    huggingface-cli download --resume-download sentence-transformers/sentence-t5-xxl \
#        --local-dir sentencet5-xxl/
#
# ============================================================================
# CRITICAL VERSION NOTES (lessons learned from DART setup)
# ============================================================================
# 1. Python 3.10+ — required for PyTorch 2.10+
# 2. numpy 1.22.4 — MotionStreamer original; stay below 1.24 (np.float removed)
# 3. setuptools<70 — CLIP setup.py needs pkg_resources, removed in 70+
# 4. PyTorch 2.10.0+cu128 — first release with sm_120 (RTX 50-series) support
# 5. CLIP: pip install via direct URL fails; clone + --no-build-isolation required
# 6. pytorch3d: pip install -e . fails; must use --no-build-isolation
# ============================================================================
